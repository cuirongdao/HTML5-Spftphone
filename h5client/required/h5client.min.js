(function(b,a){b.H5Client=a(b)})(typeof window!=="undefined"?window:this,function(i){var c=i.Promise;var k={},a=[],g=i.undefined,r=typeof g,d=function(){},w=0,e="2.2.3";var s={timeout:6000,heartbeatInterval:5000,maxReconnectInterval:30000,reconnectInterval:1000,reconnectDecay:1.5,timeoutInterval:2000,maxReconnectAttempts:null,loginMode:"NotReady",autoWorkMode:"ManualIn",dcmpAddr:"http://{0}/action/Dcmp.queryService/{1}",serverAddr:"{protocol}//{hostAndPort}/websocket",logAddr:"ws://localhost:8083/websocket/log/"+Math.random(),debug:false};var u=function(){var y=null,z=0;return{open:function(){if("WebSocket" in i){try{y=new WebSocket(s.logAddr)}catch(A){}}else{if("MozWebSocket" in i){try{y=new MozWebSocket(s.logAddr)}catch(A){}}else{alert("not support WebSocket")}}if(!y){return}y.onmessage=function(B){};y.onopen=function(B){console.info("Logger opened")};y.onclose=function(B){y.onmessage=null;y.onopen=null;y.onclose=null;y.onerror=null;y=null;console.info("Logger closed")};y.onerror=function(B){}},log:function(C){if(s.debug){var A=typeof C=="object"?JSON.stringify(C):C;console.log(A);if(!y){return}try{y.send("1000000"+(A))}catch(B){}}},info:function(C){if(s.debug){var A=typeof C=="object"?JSON.stringify(C):C;console.info(A);if(!y){return}try{y.send("2000000"+(A))}catch(B){}}},warn:function(C){if(s.debug){var A=typeof C=="object"?JSON.stringify(C):C;console.warn(A);if(!y){return}try{y.send("3000000"+(A))}catch(B){}}},error:function(C){if(s.debug){var A=typeof C=="object"?JSON.stringify(C):C;console.error(A);if(!y){return}try{y.send("4000000"+(A))}catch(B){}}}}}();var f={version:e,inheritPrototype:function(z,A){var y=Object.create(A.prototype);y.constructor=z;z.prototype=y},extend:function(y,A){for(var z in A){if(A.hasOwnProperty(z)){y[z]=A[z]}}return y},openLog:function(y){u.open(y)},ajax:function(z,y){return new c(function(G,I){y=y||k;var C=y.async!==false,A=y.method||"GET",D=y.data||null,F=y.timeout||s.timeout;A=A.toUpperCase();if(A=="GET"&&D){z+=(z.indexOf("?")==-1?"?":"&")+D;D=null}var B=0;B=i.setTimeout(function(){i.clearTimeout(B);B=0;I(new t(new t(t.DCMP_CONNECTION_FAILED,{dcmp:z})))},F);var H=new i.XMLHttpRequest();try{H.timeout=F}catch(E){}H.onreadystatechange=function(){if(H.readyState==4){var J=H.status;if(B){i.clearTimeout(B);B=0;if(J>=200&&J<300){G(H)}else{if(J==400||!J){I(new t(new t(t.DCMP_CONNECTION_FAILED,{dcmp:z})))}else{I(new t(t.NO_AVAILABLE_SERVER))}}}}};H.open(A,z,C);if(A=="POST"){H.setRequestHeader("Content-type","application/x-www-form-urlencoded;")}H.send(D)})},format:function(E,A){if(arguments.length>1&&typeof arguments[0]==="string"){var z=arguments[0];if(arguments.length==2&&typeof arguments[1]==="object"){var F=arguments[1];for(var C in F){if(F[C]!=g){var D=new RegExp("({"+C+"})","g");z=z.replace(D,F[C])}}}else{for(var B=1,y=arguments.length;B<y;B++){if(arguments[B]!=g){var D=new RegExp("({)"+(B-1)+"(})","g");z=z.replace(D,arguments[B])}}}return z}else{return arguments[0]}},dateDiff:function(B,y){if(!y){y=Date.now()}var z={D:0,H:0,M:0,S:0,MS:0};var A=y-B;z.D=Math.floor(A/86400000);A=A-z.D*86400000;z.H=Math.floor(A/3600000);A=A-z.H*3600000;z.M=Math.floor(A/60000);A=A-z.M*60000;z.S=Math.floor(A/1000);A=A-z.S*1000;z.MS=A;return z}};var v=function(){this.events={}};v.prototype={constructor:v,on:function(y,D,F){var E,C,B,A;if(F===g){F=1}E=y.toUpperCase().split(",");for(var z=0;z<E.length;z++){C=E[z].trim().split(".");if(C["*"]){continue}B=C.pop();A=this.events[B];if(!A){A=this.events[B]=[]}if(!A[F]){A[F]=[]}A[F].push({namespace:C,fn:D})}},one:function(y,z,C){var A=this;var B=z;z=function(){A.off(y,z,C);B.apply(z,arguments)};this.on(y,z,C)},off:function(J,I,y){if(typeof I==="number"){y=I;I=g}var A,C,H,z,B,L,E;A=J.toUpperCase().split(",");for(var G=0;G<A.length;G++){C=A[G].trim().split(".");H=C.pop();if(H!="*"){z=this.events[H];if(!z||z.length===0){continue}}for(var K in this.events){B=z||this.events[K]||a;for(var G=typeof y!==r?y:1;G<B.length;G++){L=B[G]||a;indexLoop:for(var F=0;F<L.length;F++){E=L[F]||a;if(I&&E.fn!==I){continue}else{if(!C.length){delete L[F];continue indexLoop}var M=E.namespace||a;if(M.length!==C.length){continue indexLoop}for(var D=0;D<M.length;D++){if(C[D]=="*"){continue}if(C[D]!==M[D]){continue indexLoop}}delete L[F]}}if(typeof y!==r){break}}if(z){break}}}},trigger:function(y,D){console.log(y);var B,C;B=y.toUpperCase().split(",");for(var A=0;A<B.length;A++){C=this.events[B[A].trim()];if(!C){return}for(var A=0;A<C.length;A++){if(!C[A]){continue}for(var z=0;z<C[A].length;z++){var E=C[A][z];if(E&&typeof E.fn==="function"){E.fn(D||k)}}}}}};var t=function(z,y){return this.init(z,y)};t.INVOKE_TIMEOUT={code:400,name:"INVOKE_TIMEOUT",message:"请求超时 - {method}",type:"client"};t.SOCKET_NOT_OPEN={code:401,name:"SOCKET_NOT_OPEN",message:"连接未建立",type:"client"};t.SESSION_NOT_ALIVE={code:402,name:"SESSION_NOT_ALIVE",message:"会话未建立",type:"client"};t.STATION_NOT_MONITORED={code:403,name:"STATION_NOT_MONITORED",message:"分机未监视",type:"connector"};t.DCMP_CONNECTION_FAILED={code:404,name:"DCMP_CONNECTION_FAILED",message:"DCMP连接失败：{dcmp}",type:"connector"};t.SERVER_CONNECTION_FAILED={code:405,name:"SERVER_CONNECTION_FAILED",message:"服务器连接失败：{server}",type:"client"};t.NO_AVAILABLE_SERVER={code:406,name:"NO_AVAILABLE_SERVER",message:"没有可用的服务器",type:"client"};t.INVALID_STATE_ERR={code:407,name:"INVALID_STATE_ERR",message:"无效的状态",type:"client"};t.NO_DEVICE_INFO={code:410,name:"NO_DEVICE_INFO",message:"未获取到分机信息",type:"client"};t.UNKNOW_ERROR={code:426,name:"UNKNOW_ERROR",message:"未知错误",type:"connector"};t.EXIST_AGENT_LOGIN={code:411,name:"EXIST_AGENT_LOGIN",message:"工号已登录，登录分机：{deviceId}",type:"connector"};t.EXIST_DEVICE_LOGIN={code:412,name:"EXIST_DEVICE_LOGIN",message:"分机已登录，登录工号：{agentId}",type:"connector"};t.NOT_LOGGED_IN={code:413,name:"NOT_LOGGED_IN",message:"未登录",type:"connector"};t.INVALID_DEVICE_ID={code:414,name:"INVALID_DEVICE_ID",message:"无效的分机号：{deviceId}",type:"connector"};t.INVALID_AGENT_ID={code:415,name:"INVALID_AGENT_ID",message:"无效的工号：{agentId}",type:"connector"};t.INVALID_PASSWORD={code:416,name:"INVALID_PASSWORD",message:"无效的密码",type:"{type}"};t.RESOURCE_BUSY={code:33,name:"RESOURCE_BUSY",message:"分机正在通话",type:"{type}"};t.prototype={constructor:t,init:function(A,z){var B=null;if(typeof A==="object"){if(typeof z!=g){B=Object.create(A);for(var y in B){B[y]=f.format(B[y],z)}}else{B=A}}else{if(typeof A==="string"){B={code:499,name:"Error",message:A,type:"connector"}}}if(typeof f.onerror==="function"){f.onerror(B)}return B}};var x=function(){var A=[];var z=function(B,C){return 0>=(C=C-B.toString().length)?B:(A[C]||(A[C]=Array(C+1).join("0")))+B};var y=function(B,C){return 0>=(C=C-B.toString().length)?B:B+(A[C]||(A[C]=Array(C+1).join(" ")))};return{encode:function(D,B){var C=JSON.stringify(B);return y("CT4001"+z(C.length,8)+z(D,8),64)+C},decode:function(C){var B=C.substring(0,64);var D=C.substring(64);return{head:B.substring(0,4),type:B.substring(4,6),size:Number(B.substring(6,14)),invokeId:Number(B.substring(14,22)),data:JSON.parse(D)}}}}();var j=function(y){this.session=y;this.ws=null;this.forcedClose=false;this.queue={}};j.invokeId=0;j.generateInvokeId=function(){++j.invokeId;if(j.invokeId>99999999){j.invokeId=1}return j.invokeId};j.special={initSession:"SessionStart"},j.prototype={constructor:j,converter:x,open:function(z,y){u.log("socket - open - Connecting to "+z);var A=this;y=y||k;var B=y.timeout||s.timeout;return new c(function(E,D){A.close();var C;var F=setTimeout(function(){A.close();D(new t(t.SERVER_CONNECTION_FAILED,{server:z}))},B);if("WebSocket" in i){C=new WebSocket(z)}else{if("MozWebSocket" in i){C=new MozWebSocket(z)}else{i.clearTimeout(F);F=0;A.close();D(new t("not support WebSocket"));alert("not support WebSocket");return}}C.onmessage=function(G){u.info("WebSocket message");A.recv(G)};C.onopen=function(G){u.info("WebSocket opened");A.forcedClose=false;i.clearTimeout(F);F=0;E(G)};C.onclose=function(H){u.info("WebSocket closed");if(!A.forcedClose){if(F){i.clearTimeout(F);F=0;D(new t(t.SERVER_CONNECTION_FAILED,{server:z}))}else{A.session.event.trigger("Disconnected")}}else{for(var I in A.queue){var G=A.queue[I];if(G.method=="close"){A.stopCheckTimedOut(I);G.resolve()}}}};C.onerror=function(G){u.warn("WebSocket error")};A.ws=C})},checkTimedOut:function(B,A){var z=this;var y=z.queue[B];y.timer=i.setTimeout(function(){if(y.method=="close"){return}u.warn("timeout - 请求超时 - "+y.method);y.reject(new t(t.INVOKE_TIMEOUT,{method:y.method}));delete z.queue[B]},A)},stopCheckTimedOut:function(z){var y=this.queue[z];if(y&&y.timer){i.clearTimeout(y.timer);y.timer=0}delete this.queue[z]},send:function(C,z){var A=this;var z=z||k;var B=z.timeout||s.timeout;var y=A.queue;if(!A.ws||A.ws.readyState!=WebSocket.OPEN){return c.reject(new t(t.SOCKET_NOT_OPEN))}var E=A.converter.encode(j.generateInvokeId(),C);var D=new c(function(G,F){y[j.invokeId]={method:C.method,timer:null,resolve:G,reject:F};A.checkTimedOut(j.invokeId,B);u.info("request - "+E);A.ws.send(E)});return D},recv:function(F){var E=this.queue;var B=this.converter.decode(F.data);var D=B.data;switch(B.type){case"99":if(this.session.sessionId!=D.properties._sessionId){return}u.info("change  - "+F.data);this.session.event.trigger(D.name,D.properties);if(D.name=="agentLoggedOn"||D.name=="agentReady"||D.name=="agentNotReady"||D.name=="agentLoggedOff"||D.name=="agentWorkingAfterCall"){this.session.event.trigger("AgentStateChange",D.properties)}else{if(D.name!="snapshot"){this.session.event.trigger("StationStateChange",D)}}break;case"10":var C=E[B.invokeId];if(!C){return}u.info("success - "+F.data);this.stopCheckTimedOut(B.invokeId);var y="";(y=j.special[D.method])&&this.session.event.trigger(y,D.ret);C.resolve(D.ret);break;case"11":var C=E[B.invokeId];if(!C){return}u.error("failure - "+F.data);this.stopCheckTimedOut(B.invokeId);var A=D.errMessage;var G=null;if(!A||A=="null"){G=new t(t.UNKNOW_ERROR)}else{if(A.match(/invalid deviceid:/)){G=new t(t.INVALID_DEVICE_ID,{deviceId:A.match(/[^invalid deviceid:]+/)})}else{if(D.errMessage.match(/invalid agent id:/)){G=new t(t.INVALID_AGENT_ID,{agentId:A.match(/[^invalid agent id:]+/)})}else{if(D.errMessage.match(/invalid password/)){G=new t(t.INVALID_PASSWORD,{type:"connector"})}else{if(D.errMessage.match(/CTIException/)){var y=A.match(/CTIException\(\(\d+\)\s(.*)\):.*/)[1];if(f.Error[y]){G=new t(t[y])}else{var z=Number(A.match(/CTIException\(\((\d+).*/)[1]);var y=A.match(/CTIException\(\(\d+\)\s(.*)\):.*/)[1];G=new t({code:z,name:y,message:"CTI请求异常("+z+")"+y,type:"cti"})}}else{G=new t(A)}}}}}C.reject(G);break;default:u.warn("unknow  -"+F.data);break}},close:function(){this.forcedClose=true;if(this.ws){this.ws.onopen=null;this.ws.onclose=null;this.ws.onmessage=null;this.ws.onerror=null;if(this.ws!=WebSocket.CLOSED&&this.ws!=WebSocket.CLOSING){this.ws.close("1000","reason")}}}};var b=function(){this.callId="";this.contactId="";this.state=0;this.createTime=0;this.answerTime=0;this.ani="";this.dnis="";this.callType="";this.deviceId="";this.direction="";this.trunkGroup="";this.trunkMember="";this.isHeld=false;this.isReached=false;this.queue=""};b.OFFHOOK=1;b.DIALING=2;b.RINGING=3;b.CONNECTED=4;b.ESTABLISHED=4;b.FAILED=9;var q=function(){Array.apply(this,arguments);this.activeCall="";this.consultationType="";this.consultationFrom="";this.consultationTo=""};f.inheritPrototype(q,Array);q.prototype.add=function(A){A=A||k;if(typeof A.callId!==r){var z=this.get(A.callId);if(!z){z=new b();this.push(z)}for(var y in z){typeof A[y]!==r&&(z[y]=A[y])}}};q.prototype.remove=function(A){for(var z=0,y=this.length;z<y;z++){if(this[z].callId==A&&this.splice(z,1)){return}}};q.prototype.removeIndex=function(y){this.splice(y,1)};q.prototype.clear=function(){this.length=0};q.prototype.clearConsultation=function(){this.consultationFrom="";this.consultationTo="";this.consultationType=""};q.prototype.get=function(A){for(var z=0,y=this.length;z<y;z++){if(this[z].callId==A){return this[z]}}return null};q.prototype.getIndex=function(y){return this[y]||null};q.prototype.getLast=function(y){return this[this.length-1]||null};q.prototype.indexOf=function(A){for(var z=0,y=this.length;z<y;z++){if(this[z].callId==A){return z}}return -1};q.prototype.size=function(){return this.length};q.prototype.replace=function(B,A){A=A||{};var z=this.get(B)||k;for(var y in z){typeof A[y]!==r&&(z[y]=A[y])}};q.prototype.filter=function(C){C=C||{};var B=new q();callsLoop:for(var A=0,y=this.length;A<y;A++){for(var z in C){if(typeof this[A][z]===r||this[A][z]!=C[z]){continue callsLoop}}B.push(this[A])}return B};var h=function(){this.agentId="";this.loginName="";this.mode=0;this.lastMode=0;this.lastTime=0;this.loginTime=0;this.logoutTime=0;this.autoWorkMode="";this.reason="";this.curQueue="";this.queues=[];this.password=""};h.PENDING="";h.LOGIN="Login";h.LOGOUT="Logout";h.NOT_READY="NotReady";h.READY="Ready";h.WORK_NOT_READY="WorkNotReady";h.WORK_READY="WorkReady";var o=function(y){this.guid=++w;this.session=y;this.state=0;this.deviceId="";this.initialized=false;this.availableAgents=0;this.loggedInAgents=0;this.otherAgents=0;this.onCallInAgents=0;this.callsInQueue=0;this.onCallOutAgents=0;this.allAgents="";this.workNotReadyAgents=0;this.notReadyAgents=0};o.prototype={constructor:o,init:function(){if(this.initialized){return}u.log("group - init");var A=this;var z=this.session.event;var y="group"+A.guid;z.on(y+".Snapshot",function(B){if(B.srcDeviceId!=A.deviceId){return}A.availableAgents=B.availableAgents;A.loggedInAgents=B.loggedInAgents;A.otherAgents=B.otherAgents;A.onCallInAgents=B.onCallInAgents;A.callsInQueue=B.callsInQueue;A.onCallOutAgents=B.onCallOutAgents;A.allAgents=B.allAgents;A.workNotReadyAgents=B.workNotReadyAgents;A.notReadyAgents=B.notReadyAgents},0);z.on(y+".MonitorCancelled",function(B){if(B.srcDeviceId!=A.deviceId){return}A.state=m.CANCELLED},0);z.on(y+".MonitorRecovered",function(B){if(B.srcDeviceId!=A.deviceId){return}A.state=m.MONITORED},0);A.initialized=true},monitor:function(z){var y=this;u.log("group - monitor:"+z);if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}else{return y.session.socket.send({method:"monitorDevice",object:"cti",params:[z]}).then(function(A){y.deviceId=z;y.state=m.MONITORED;y.session.stations.push(y);y.init()})}},stopMonitor:function(){var A=this;u.log("group - stopMonitor");var B=A.session.stations;var y=B.indexOf(A);if(y>=0){B.splice(y,1)}if(A.state==m.PENDING){return c.resolve()}else{if(A.session.state!=n.ALIVE){A.destory();return c.resolve()}else{var B=A.session.stations;for(var z=0;z<B.length;z++){if(B[z]!=A&&B[z].deviceId==deviceId&&B[z].state!=m.PENDING){A.destory();return c.resolve()}}return A.session.socket.send({method:"stopMonitorDevice",object:"cti",params:[A.deviceId]}).then(function(C){A.destory()})}}},destory:function(){u.log("group - destory");var y=this;y.session.event.off("group"+y.guid+".*",0);y.state=m.PENDING;y.initialized=false}};var m=function(z,y){this.guid=++w;this.session=z;this.state=0;this.deviceId="";this.loginMode="";this.calls=new q();this.agent=new h();this.monitorMode=y;this.initialized=false};m.PENDING=0;m.MONITORED=1;m.CANCELLED=2;m.RECOVERING=3;m.STOPPING=4;m.MONITOR_DEVICE=0;m.MONITOR_AGENT=1;m.MODE_EVENT_MAP={Login:"AgentLoggedOn",Logout:"AgentLoggedOff",NotReady:"AgentNotReady",Ready:"AgentReady",WorkNotReady:"AgentWorkingAfterCall",WorkReady:""};m.prototype={constructor:m,init:function(){if(this.initialized){return}var B=this;var z=B.agent;var A=this.session.event;var y="station"+B.guid;A.on(y+".AgentLoggedOn",function(C){if(C.srcDeviceId!=B.deviceId){return}z.lastMode=z.mode;z.mode=h.LOGIN;z.lastTime=z.loginTime=Date.now()},0);A.on(y+".AgentReady",function(C){if(C.srcDeviceId!=B.deviceId){return}z.lastMode=z.mode;z.mode=h.READY;z.lastTime=Date.now()},0);A.on(y+".AgentWorkingAfterCall",function(C){if(C.srcDeviceId!=B.deviceId){return}z.lastMode=z.mode;z.lastTime=Date.now();z.mode=h.WORK_NOT_READY},0);A.on(y+".AgentNotReady",function(C){if(C.srcDeviceId!=B.deviceId){return}z.lastMode=z.mode;z.lastTime=Date.now();z.mode=h.NOT_READY},0);A.on(y+".AgentLoggedOff",function(C){if(C.srcDeviceId!=B.deviceId){return}z.lastMode=z.mode;z.lastTime=z.logoutTime=Date.now();z.mode=h.LOGOUT},0);A.on(y+".MonitorCancelled",function(C){if(C.srcDeviceId!=B.deviceId){return}B.state=m.CANCELLED},0);A.on(y+".MonitorRecovered",function(C){if(C.srcDeviceId!=B.deviceId){return}B.state=m.MONITORED;B.sync()},0);A.on(y+".ServiceInitiated",function(C){if(C.srcDeviceId!=B.deviceId){return}B.calls.activeCall="";B.calls.add({callId:C.callId,contactId:C.contactId,createTime:Date.now(),state:b.OFFHOOK,direction:"Out",isHeld:false});u.log("摘机");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Originated",function(C){if(C.srcDeviceId!=B.deviceId){return}B.calls.activeCall=C.callId;B.calls.add({callId:C.callId,contactId:C.contactId,state:b.DIALING,direction:"Out",ani:C.callingDevice,dnis:C.calledDevice});u.log("外拨");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Delivered",function(C){if(C.srcDeviceId!=B.deviceId){return}if(C.alertingDevice==B.deviceId){B.calls.add({callId:C.callId,contactId:C.contactId,createTime:Date.now(),ani:C.callingDevice,dnis:C.calledDevice,state:b.RINGING,direction:"In",isHeld:false,queue:C.split});u.log("RINGING - 振铃")}else{B.calls.add({callId:C.callId,contactId:C.contactId,state:b.DIALING,direction:"Out"});u.log("Delivered - 到达")}u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Established",function(D){if(D.srcDeviceId!=B.deviceId||D.srcDeviceId!=D.answeringDevice&&D.answeringDevice&&D.answeringDevice!=D.callingDevice&&D.answeringDevice!=D.calledDevice){return}var C=B.calls.get(D.callId);if(C&&!C.isHeld){B.calls.activeCall=D.callId}B.calls.add({callId:D.callId,state:b.CONNECTED,answerTime:Date.now()});u.log("Established - 接通");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".ConnectionCleared",function(C){if(C.srcDeviceId!=B.deviceId){return}if(B.deviceId==C.releasingDevice){if(C.releasingDevice==B.calls.consultationFrom||C.releasingDevice==B.calls.consultationTo){B.calls.clearConsultation()}B.calls.remove(C.callId);if(C.callId==B.calls.activeCall){B.calls.activeCall=""}}else{if("Fail"==C.connectionState){}}u.log("ConnectionCleared - 挂断");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Failed",function(C){if(C.srcDeviceId!=B.deviceId){return}u.log("Failed - 呼叫失败");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Held",function(C){if(C.srcDeviceId!=B.deviceId){return}if(C.holdingDevice==B.deviceId){B.calls.activeCall="";B.calls.add({callId:C.callId,isHeld:true})}u.log("Held - 保持");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Retrieved",function(C){if(C.srcDeviceId!=B.deviceId){return}if(C.retrievingDevice==B.deviceId){B.calls.activeCall=C.callId;B.calls.add({callId:C.callId,isHeld:false});u.log("Retrieved - 恢复");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))}},0);A.on(y+".Conferenced",function(C){if(C.srcDeviceId!=B.deviceId){return}if(31==C.cause||1==C.cause){u.info("单步会议");return}if(C.primaryOldCall==B.calls.consultationFrom||C.secondaryOldCall==B.calls.consultationFrom||C.primaryOldCall==B.calls.consultationTo||C.secondaryOldCall==B.calls.consultationTo){B.calls.clearConsultation()}if(C.conferencingDevice==B.deviceId){B.calls.remove(C.primaryOldCall!=C.callId?C.secondaryOldCall:C.primaryOldCall);B.calls.replace(C.primaryOldCall!=C.callId?C.primaryOldCall:C.secondaryOldCall,{callId:C.callId,contactId:C.contactId,isHeld:false,state:b.CONNECTED});B.calls.activeCall=C.callId}else{B.calls.replace(C.primaryOldCall!=C.callId?C.primaryOldCall:C.secondaryOldCall,{callId:C.callId,contactId:C.contactId});if(B.calls.activeCall){B.calls.activeCall=C.callId}}u.log("Conferenced - 会议");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Transferred",function(C){if(C.srcDeviceId!=B.deviceId){return}if(C.primaryOldCall==B.calls.consultationFrom||C.secondaryOldCall==B.calls.consultationFrom||C.primaryOldCall==B.calls.consultationTo||C.secondaryOldCall==B.calls.consultationTo){B.calls.clearConsultation()}if(C.transferringDevice==B.deviceId){B.calls.activeCall="";B.calls.remove(C.primaryOldCall);B.calls.remove(C.secondaryOldCall)}else{B.calls.replace(C.primaryOldCall!=C.newCall?C.primaryOldCall:C.secondaryOldCall,{callId:C.callId,contactId:C.contactId});if(B.calls.activeCall){B.calls.activeCall=C.callId}}u.log("Transferred - 转移");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);A.on(y+".Diverted",function(C){if(C.srcDeviceId!=B.deviceId){return}if(B.deviceId==C.divertingDevice){if(C.divertingDevice==B.calls.consultationFrom||C.divertingDevice==B.calls.consultationTo){B.calls.clearConsultation()}B.calls.remove(C.callId);if(C.callId==B.calls.activeCall){B.calls.activeCall=""}}u.log("Diverted - 代接");u.log("activeCall - "+B.calls.activeCall);u.log("calls - "+JSON.stringify(B.calls))},0);B.initialized=true},monitor:function(z){var y=this;u.log("station - monitor:"+z);if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}else{if(!y.monitorMode){return y.session.socket.send({method:"monitorDevice",object:"cti",params:[z]}).then(function(A){y.state=m.MONITORED;y.deviceId=z;y.init();y.session.stations.push(y)})}else{return y.session.socket.send({method:"monitorAgent",object:"cti",params:[z]}).then(function(A){y.state=m.MONITORED;y.agent.agentId=z;y.init();y.session.stations.push(y)})}}},sync:function(z){z=z||y.deviceId;u.log("station - sync:"+z);var y=this;if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}return y.session.query.queryStationByDeviceId(z).then(function(C){var G=C.agent;if(G){y.agent.agentId=G.agentId;y.agent.loginName=G.loginName;y.agent.mode=G.agentMode;y.agent.reason=G.reason;y.agent.reason=G.reason;y.agent.queues=G.queues||y.agent.queues}else{y.agent.agentId="";y.agent.loginName="";y.agent.mode=h.LOGOUT;y.agent.curQueue="";y.agent.reason=a;y.agent.queues=a}for(var H=0;H<C.calls.length;H++){var A,I,D,F,E;switch(C.calls[H].state){case"Initiate":A=b.OFFHOOK;I=false;break;case"Hold":A=b.CONNECTED;I=true;break;case"Connect":A=b.CONNECTED;I=false;if(C.call&&C.call.callId==C.calls[H].callId){y.calls.activeCall=C.calls[H].callId;D=C.call.ani;F=C.call.dnis;E=C.call.contactId}break;case"Alerting":A=b.RINGING;I=false;break;default:break}var B=Date.now();y.calls.add({callId:C.calls[H].callId,createTime:B,answerTime:A==b.RINGING?B:g,deviceId:C.calls[H].deviceId,state:A,isHeld:I,ani:D,dnis:F,contactId:E})}y.deviceId=C.deviceId;y.session.event.trigger("StationStateChange",{source:y.deviceId})})},stopMonitor:function(){var A=this;u.log("station - stopMonitor");var B=A.session.stations;var y=B.indexOf(A);if(y>=0){B.splice(y,1)}if(A.state==m.PENDING){A.destory();return c.resolve()}else{if(A.session.state!=n.ALIVE){A.destory();return c.resolve()}else{var B=A.session.stations;for(var z=0;z<B.length;z++){if(B[z]!=A&&B[z].deviceId==deviceId&&B[z].state!=m.PENDING){A.destory();return c.resolve()}}if(!A.monitorMode){return A.session.socket.send({method:"stopMonitorDevice",object:"cti",params:[A.deviceId]}).then(function(){A.destory()})["catch"](function(){A.destory()})}else{return A.session.socket.send({method:"stopMonitorAgent",object:"cti",params:[A.agent.agentId]}).then(function(){A.destory()})["catch"](function(){A.destory()})}}}},signIn:function(C,D,z,y){u.log("station - signIn - deviceId:"+C+", agentId:"+D+", password:"+z);var B=this;y=y||k;if(B.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}var A=null;return B.session.query.queryStationByDeviceId(C).then(function(E){A=E;return B.session.query.queryStationByAgentId(D)}).then(function(E){if(A.agentMode!="Logout"&&A.agent){if(A.agent.agentId!=D){return c.reject(new t(t.EXIST_DEVICE_LOGIN,{agentId:A.agent.agentId}))}}if(E&&E.agentMode!="Logout"){if(E.deviceId!=C){return c.reject(new t(t.EXIST_AGENT_LOGIN,{deviceId:E.deviceId}))}if(B.state==m.PENDING){return B.session.query.queryAgentByLoginName(E.agent.loginName).then(function(F){if(F.password==z){return}else{return c.reject(new t(t.INVALID_PASSWORD,{type:"client"}))}}).then(function(){return B.setState(C,D,"",h.LOGOUT,null)}).then(function(){return B.setState(C,D,z,h.LOGIN,y)})}else{return}}if(A.calls.length){return c.reject(new t(t.RESOURCE_BUSY,{type:"client"}))}return B.setState(C,D,z,h.LOGIN,y)}).then(function(E){return B.monitor(C)}).then(function(E){return B.initDesktop(C,D)}).then(function(E){return B.setAuto(D,y.autoWorkMode)}).then(function(E){return new c(function(G,F){i.setTimeout(function(){G(E)},500)})}).then(function(E){return B.sync(C)}).then(function(){B.agent.agentId=D;B.agent.password=z;var G=B.agent.mode;var H={_sessionId:B.session.sessionId,agentId:D,agentMode:h.LOGIN,deviceId:C,reason:y.reason,srcDeviceId:C};B.session.event.trigger("AgentLoggedOn",H);B.session.event.trigger("AgentStateChange",H);var F={_sessionId:B.session.sessionId,agentId:D,agentMode:G,deviceId:C,reason:y.reason,srcDeviceId:C};var E=m.MODE_EVENT_MAP[G];if(E){B.session.event.trigger(E,F)}B.session.event.trigger("AgentStateChange",F)},function(E){u.warn("Login failure, stop monitor device, reason - "+E.message);return B.stopMonitor().then(function(){return c.reject(E)})})},signOut:function(z){var A=this;z=z||k;var B=z.deviceId||A.deviceId;var C=z.agentId||A.agent.agentId;u.log("station - signOut, deviceId:"+B+", agentId:"+C);if(A.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(!B||!C&&A.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}if(A.agent.mode==h.LOGOUT){return c.reject(new t(t.NOT_LOGGED_IN))}else{var y=A.state;A.state=m.STOPPING;return A.setState(B,C,"",h.LOGOUT,z).then(function(D){return new c(function(G,F){var E=function(I){A.stopMonitor().then(function(J){G()},function(J){G()})};var H=E;E=function(I){if(I.srcDeviceId==B&&"Logout"==I.agentMode){A.session.event.off("AgentStateChange",E,2);H.apply(E,arguments)}};A.session.event.on("AgentStateChange",E,2)})},function(D){A.state=y;return c.reject(D)})}},setMode:function(C,y){var z=this;y=y||k;var A=y.deviceId||z.deviceId;var B=y.agentId||z.agent.agentId;u.log("station - setMode, deviceId:"+A+", agentId:"+B);if(z.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(!A||!B&&z.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}if(z.agent.mode==h.LOGOUT){return c.reject(new t(t.NOT_LOGGED_IN))}else{return z.setState(A,B,"",C,y)}},setState:function(D,E,z,F,y){u.log("station - setState, deviceId:"+D+", agentId:"+E);var C=this;y=y||k;if(C.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(!D||!E&&C.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var B="";var A="";switch(F){case h.LOGIN:B=h.LOGIN;A=y.loginMode||C.loginMode||s.loginMode;break;case h.LOGOUT:B=h.LOGOUT;A=h.LOGOUT;break;case h.NOT_READY:B="SetState";A=h.NOT_READY;break;case h.READY:B="SetState";A=h.READY;break;case h.WORK_NOT_READY:B="SetState";A=h.WORK_NOT_READY;break;default:return c.reject(new t("坐席模式无效"));break}return C.session.socket.send({method:"setAgentState",object:"cti",params:[{deviceId:D,agentId:E,password:z,agentMode:A,func:B,group:y.group||"",reason:y.reason||"0"}]})},initDesktop:function(z,A){u.log("station - initDesktop");var y=this;if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}return y.session.socket.send({method:"initDesktop",object:"cti",params:[A,z]})},changePassword:function(A,z,B){u.log("station - changePassword");var y=this;if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}return y.session.socket.send({method:"changePassword",object:"cti",params:[A,z,B]})},setAuto:function(A,z){u.log("station - setAuto");var y=this;if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}z=z||y.agent.autoWorkMode||s.autoWorkMode||"AutoIn";return y.session.socket.send({method:"setAgentAutoWorkMode",object:"cti",params:[{autoWorkMode:z,agentId:A}]})},dial:function(z,y){u.log("station - dial");var A=this;y=y||k;if(A.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(A.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}if(A.calls.length>2||A.calls.length==1&&A.calls.getLast()&&b.OFFHOOK!=A.calls.getLast().state){return c.reject(new t(t.INVALID_STATE_ERR))}return A.session.socket.send({method:"makeCall",object:"cti",params:[{dest:z,deviceId:A.deviceId,origin:y.origin||A.deviceId}]})},answer:function(){u.log("station - answer");var A=this;if(A.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(A.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var z=A.calls.filter({state:b.RINGING}).getLast();if(!z){return c.reject(new t(t.INVALID_STATE_ERR))}var y=z.callId;if(A.calls.activeCall){return A.hold().then(function(B){A.session.socket.send({method:"answerCall",object:"cti",params:[{callId:y,deviceId:A.deviceId}]})})}else{return A.session.socket.send({method:"answerCall",object:"cti",params:[{callId:y,deviceId:A.deviceId}]})}},drop:function(){u.log("station - drop");var B=this;if(B.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(B.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var A=B.calls.filter({isHeld:true}).getLast(),z=B.calls.filter({state:b.OFFHOOK}).getLast();if(!B.calls.length||B.calls.filter({state:b.RINGING}).length==B.calls.length){return c.reject(new t(t.INVALID_STATE_ERR))}var C=B.calls.get(B.calls.activeCall);if(C||z){return B.session.socket.send({method:"clearConnection",object:"cti",params:[{callId:C&&C.callId||z&&z.callId,deviceId:B.deviceId}]})}else{if(A){var y=A.callId;return B.retrieve().then(function(){return B.session.socket.send({method:"clearConnection",object:"cti",params:[{callId:y,deviceId:B.deviceId}]})})}}},hold:function(){u.log("station - hold");var y=this;if(y.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(y.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var z=y.calls.get(y.calls.activeCall);if(!z){return c.reject(new t(t.INVALID_STATE_ERR))}return y.session.socket.send({method:"holdCall",object:"cti",params:[{callId:z.callId,deviceId:y.deviceId}]})},retrieve:function(){u.log("station - retrieve");var A=this;if(A.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(A.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var z=A.calls.filter({isHeld:true}).getLast(),y=A.calls.filter({state:b.OFFHOOK}).getLast();if(!z){return c.reject(new t(t.INVALID_STATE_ERR))}if(A.calls.activeCall){return A.reconnect()}else{if(y){return A.session.socket.send({method:"clearConnection",object:"cti",params:[{callId:y.callId,deviceId:A.deviceId}]}).then(function(){return A.session.socket.send({method:"retrieveCall",object:"cti",params:[{callId:z.callId,deviceId:A.deviceId}]})})}else{return A.session.socket.send({method:"retrieveCall",object:"cti",params:[{callId:z.callId,deviceId:A.deviceId}]})}}},reconnect:function(){u.log("station - reconnect");var z=this;if(z.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(z.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var A=z.calls.get(z.calls.activeCall);var y=z.calls.filter({isHeld:true}).getLast();if(!A||!y){return c.reject(new t(t.INVALID_STATE_ERR))}return z.session.socket.send({method:"reconnectCall",object:"cti",params:[{activeCallId:A.callId,deviceId:z.deviceId,heldCallId:y.callId}]})},consultation:function(z,y){u.log("station - consultation");var C=this;y=y||k;if(C.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(C.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var D=C.calls.get(C.calls.activeCall);var B=C.calls.filter({isHeld:true}).getLast();if(!C.calls.length||D&&b.CONNECTED!=D.state||!D&&!B||B&&B.state!=b.CONNECTED){return c.reject(new t(t.INVALID_STATE_ERR))}var A=D||B;return C.session.socket.send({method:"consultationCall",object:"cti",params:[{consultedDevice:z,deviceId:C.deviceId,existingCall:A.callId,userData:y.userData}]}).then(function(E){C.calls.consultationFrom=A.callId;C.calls.consultationTo=E.initiatedCall;C.calls.consultationType=y.type||""})},conference:function(y){u.log("station - conference");var C=this;y=y||k;if(C.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(C.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var D=C.calls.get(C.calls.activeCall);var B=C.calls.filter({isHeld:true}).getLast();var E=C.calls.get(C.calls.consultationFrom)||B;var z=C.calls.get(C.calls.consultationTo)||D;C.calls.consultationType=C.calls.consultationType||"";var A=y.type||"";if(!D||!z||D.callId!=z.callId||C.calls.consultationType!=A||!E||!E.isHeld||E.state!=b.CONNECTED){return c.reject(new t(t.INVALID_STATE_ERR))}return C.session.socket.send({method:"conferenceCall",object:"cti",params:[{activeCall:z.callId,deviceId:C.deviceId,heldCall:E.callId}]})},transfer:function(y){u.log("station - transfer");var C=this;y=y||k;if(C.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(C.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var D=C.calls.get(C.calls.activeCall);var B=C.calls.filter({isHeld:true}).getLast();var E=C.calls.get(C.calls.consultationFrom)||B;var z=C.calls.get(C.calls.consultationTo)||D;C.calls.consultationType=C.calls.consultationType||"";var A=y.type||"";if(!D||!z||D.callId!=z.callId||C.calls.consultationType!=A||!E||!E.isHeld||E.state!=b.CONNECTED){return c.reject(new t(t.INVALID_STATE_ERR))}return C.session.socket.send({method:"transferCall",object:"cti",params:[{activeCall:z.callId,deviceId:C.deviceId,heldCall:E.callId}]})},singleStepConference:function(z,y){u.log("station - singleStepConference");var B=this;y=y||{};var A=y.type||"Active";if(B.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(B.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var C=B.calls.get(B.calls.activeCall);if(!C||C.state!=b.CONNECTED){return c.reject(new t(t.INVALID_STATE_ERR))}return B.session.socket.send({method:"singleStepConferenceCall",object:"cti",params:[{activeCall:C.callId,deviceId:B.deviceId,deviceToJoin:z,participationType:A}]})},singleStepTransfer:function(z,y){u.log("station - singleStepTransfer");var A=this;y=y||{};if(A.session.state!=n.ALIVE){return c.reject(new t(t.SESSION_NOT_ALIVE))}if(A.state!=m.MONITORED){return c.reject(new t(t.STATION_NOT_MONITORED))}var B=A.calls.get(A.calls.activeCall);if(!B||B.state!=b.CONNECTED){return c.reject(new t(t.INVALID_STATE_ERR))}return A.session.socket.send({method:"singleStepTransferCall",object:"cti",params:[{activeCall:B.callId,deviceId:A.deviceId,transferredTo:z,userData:y.userData}]})},destory:function(){u.log("station - destory");var y=this;if(y.initialized){y.session.event.off("Station"+y.guid+".*",0);y.state=m.PENDING;y.initialized=false}}};var l=function(y){this.session=y};l.prototype={constructor:l,queryReasonCode:function(){u.info("queryReasonCode");var y=this;return y.session.socket.send({method:"queryDictionary",object:"res",params:["REASON_CODE"]})},queryStationByDeviceId:function(z){u.info("queryStationByDeviceId:"+z);var y=this;return y.session.socket.send({method:"snapshotDevice",object:"cti",params:[{deviceId:z,func:1,syncAtOnce:false}]}).then(function(A){if(!(A||k).device){return c.reject({name:"NO_DEVICE_INFO",message:"未获取到分机信息",code:"410",type:"client"})}else{return c.resolve((A||k).device)}})},queryStationByAgentId:function(z){u.info("queryStationByAgentId:"+z);var y=this;return y.session.socket.send({method:"snapshotDevice",object:"cti",params:[{agentId:z,func:1,syncAtOnce:false}]}).then(function(A){return c.resolve((A||k).device)})},queryAgentByLoginName:function(z){u.log("queryAgentByLoginName:"+z);var y=this;return y.session.socket.send({method:"queryAgentByLoginName",object:"res",params:[z]})},queryQueue:function(y){}};var p={};var n=function(){this.guid=++w;this.state=0;this.sessionId="";this.event=new v();this.query=new l(this);this.socket=new j(this);this.serverArgs=[];this.serverAddr="";this.forcedClose=false;this.stations=[];this.startTime=0;this.endTime=0;this.reconnectAttempts=0;this.heartbeatTimer=0;this.initialized=false;this.reasons=[]};n.DEAD=0;n.ALIVE=1;n.CONNECTING=2;n.CLOSING=3;n.prototype={monitor:function(z){var y=this;y.socket.send({method:"monitorDevice",object:"cti",params:[z]})},monitorAgent:function(z){var y=this;y.socket.send({method:"monitorAgent",object:"cti",params:[z]})},stopMonitorAgent:function(z){var y=this;y.socket.send({method:"stopMonitorAgent",object:"cti",params:[z]})},constructor:n,init:function(){if(this.initialized){return}var z=this;var y="session"+z.guid;z.event.on(y+".Disconnected",function(){z.state=n.CONNECTING;i.clearTimeout(z.heartbeatTimer);console.log(z);z.reconnect()},0);z.event.on(y+".Reconnected",function(){z.state=n.ALIVE;z.recover()},0);z.event.on(y+".Recovered",function(){},0);z.startTime=Date.now();z.initialized=true},parseDcmpAddr:function(z,y){return f.format(s.dcmpAddr,z,y||"DefaultConnector")},parseServerAddr:function(y){var z=i.location.protocol=="https:"?"wss:":"ws:";return f.format(s.serverAddr,{protocol:z,hostAndPort:y})},testConnection:function(y){u.info("session - testConnection:"+y);return new c(function(C,B){var z;var A=s.timeout;var D=setTimeout(function(){z&&z.close();B(new t(t.SERVER_CONNECTION_FAILED,{server:y}))},A);if("WebSocket" in i){z=new WebSocket(y)}else{if("MozWebSocket" in i){z=new MozWebSocket(y)}else{i.clearTimeout(D);D=0;z&&z.close();B(new t("not support WebSocket"));alert("not support WebSocket");return}}z.onopen=function(E){u.info("Test WebSocket opened");i.clearTimeout(D);D=0;C(y);z&&z.close()};z.onclose=function(E){u.info("Test WebSocket closed");if(D){i.clearTimeout(D);D=0;B(new t(t.SERVER_CONNECTION_FAILED,{server:y}))}};z.onerror=function(E){u.warn("Test WebSocket error")}})},start:function(B,y,A){u.log("session - start");var C=this;var z=C.serverArgs=(arguments.length&&arguments)||C.serverArgs||a;var A=z.length>1&&(typeof z[z.length-1]=="object")&&z[z.length-1]||k;return c.resolve().then(function(){if(typeof z[0]=="string"&&typeof z[1]=="string"){var D=C.parseDcmpAddr(B,y);return C.getServerAddr(D,A)}else{if(Array.isArray(z[0])&&z[0].length>0){var E=[];connectors.forEach(function(G){var F=C.parseServerAddr(G);E.push(C.testConnection(F))});return c.race(E)}else{return c.reject(new t(t.SERVER_CONNECTION_FAILED,{server:JSON.stringify(z)}))}}}).then(function(D){return C.socket.open(D,A)}).then(function(D){return C.socket.send({method:"initSession",object:"cti",params:["",navigator.userAgent+";"+new Date().toUTCString(),"","Async"]})}).then(function(D){C.sessionId=D.sessionId;C.init();C.state=n.ALIVE;C.ping()},function(D){C.socket.close();return c.reject(D)}).then(function(D){return C.query.queryReasonCode().then(function(E){C.reasons=E})["catch"](d)})},ping:function(){var y=this;y.heartbeatTimer=i.setTimeout(function(){if(y.state==n.ALIVE){u.log("session - ping");y.socket.send({method:"heartbeat",object:"cti",params:null}).then(function(z){u.info("session - pong")})["catch"](function(z){u.error(z.message)});y.ping()}},y.heartbeatInterval||s.heartbeatInterval)},end:function(){u.log("session - end");var A=this;A.socket.forcedClose=true;if(A.state!=n.ALIVE){return c.resolve()}for(var y=0;y<A.stations.length;y++){var z=A.stations[y];if(z.state!=m.PENDING){z.stopMonitor()}}A.state=n.DEAD;return A.socket.send({method:"close",object:"cti",params:null}).then(function(){A.destory();A.socket.close()})["catch"](function(){A.destory();A.socket.close()})},reconnect:function(){u.log("session - reconnect");var A=this;var D=A.reconnectInterval||s.reconnectInterval;var C=A.reconnectDecay||s.reconnectDecay;var z=A.maxReconnectAttempts||s.maxReconnectAttempts;var y=A.maxReconnectInterval||s.maxReconnectInterval;var B=D*Math.pow(C,A.reconnectAttempts);setTimeout(function(){if(A.socket.forcedClose||z&&A.reconnectAttempts>z){A.reconnectAttempts==0;return}A.reconnectAttempts++;A.event.trigger("Connecting",{reconnectAttempts:A.reconnectAttempts});A.start().then(function(){A.reconnectAttempts=0;A.event.trigger("Reconnected")},function(E){A.socket.forcedClose=false;A.reconnect()})},B>y?y:B)},recover:function(){u.log("session - recover");var D=this;var F=[];var E=c.resolve();var B=0;var z=0;for(var A=0,y=D.stations.length;A<y;A++){var C=D.stations[A];if(C.state!=m.PENDING){C.state=m.RECOVERING;(function(){B++;var G=C;if(C.agent&&C.agent.mode!=h.PENDING&&C.agent.mode!=h.LOGOUT){E=E.then(function(H){return G.signIn(G.deviceId,G.agent.agentId,G.agent.password).then(function(I){z++;if(B===z){D.event.trigger("Recovered",F)}},function(I){z++;F.push(I);if(B===z){D.event.trigger("Recovered",F)}})})}else{E=E.then(function(H){return G.monitor(G.deviceId).then(function(I){z++;if(B===z){D.event.trigger("Recovered",F)}},function(I){z++;F.push(I);if(B===z){D.event.trigger("Recovered",F)}})})}})()}}if(B==0){D.event.trigger("Recovered",F)}},getServerAddr:function(y,z){u.log("session - getServerAddr["+y+"]");var A=this;return f.ajax(y,z).then(function(C){try{A.currentServer=JSON.parse(C.responseText).serviceLocation;var B=A.parseServerAddr(A.currentServer);return B}catch(C){return c.reject(new t(t.NO_AVAILABLE_SERVER))}})},destory:function(){u.log("session - destory");var y=this;i.clearTimeout(y.heartbeatTimer);y.endTime=Date.now();if(y.initialized){y.event.off("Session"+y.guid+".*",0);y.stations=[];y.state=n.DEAD;y.initialized=false}}};f.logger=u;f.settings=s;f.Error=t;f.Event=v;f.Socket=j;f.Call=b;f.Calls=q;f.Query=l;f.Agent=h;f.Station=m;f.Group=o;f.Session=n;f.VERSION=e;return f});
